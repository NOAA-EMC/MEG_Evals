<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GFSv16/GFSv15 Comparisons</title>
  <link rel="stylesheet" type="text/css" href="panel5.css">
  <!--<script src="https://d3js.org/d3.v4.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script type="text/javascript" src="http://canvg.github.io/canvg/rgbcolor.js"></script> 
  <script type="text/javascript" src="http://canvg.github.io/canvg/StackBlur.js"></script>
  <script type="text/javascript" src="http://canvg.github.io/canvg/canvg.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.5/bluebird.min.js"></script>
<!--<script src="https://d3js.org/d3-geo.v1.min.js"></script>-->
</head>

<!--<body onload="document.getElementById('toggle').checked = '';">-->
<!--<body onload="corno()">-->
<!--<div class="pagecontainer">-->
<div id="mastercontainer" class="mastercontainer">
  <div id="maincontainer" class="maincontainer">
    <div id="dcontainer" class="pncontainer">
  <div id="info" class="info">i</div>
   <div id="divdropimage1" class="select">
    <div id="afterdropimage1" class="select-styled">
    </div>
    </div>
     <div id="divdropcyclemenu" class="cycleselect">
      <div id="afterdropcyclemenu" class="select-styled"></div>
     </div>
      <input type="button" value="Previous image" id="previous" class="pn" onclick="previous()"></input>
      <input type="button" value="Next image"  id="next" class="pn" onclick="next()"></input>
    <div class="dpdtcontainer">
      <div class="dpdt">dprog/dt</div>
      <input type="checkbox" id="toggle" name="toggle" >
      <label for="toggle"></label>
    </div>
  <!--<div id="status" class="status">status</div>-->
    </div>
   <!-- <div id="topsub" class="subcontainer">-->
      <!--<span class="helper"></span><img id="image1" src="2017020912nerefchrrr1.gif" class="imagetop">-->
      <div id="cimage1" class="cimage1">
        <img id="image1"  class="image1">
      </div>
    <!--</div>-->
    
  </div>
</div><div id="sidecontainer" class="sidecontainer">
   <div id="divdomain" class="select">
    <div id="afterdomain" class="select-styled">
    </div>
    </div>
    <div id="fboxcontainer" class="fboxcontainer">
       <div id="cfboxcontainer" class="cfboxcontainer">
       </div>
    <!--<div class="fbox"></div>-->
    </div>
      <input type="button" value="Get shareable URL"  id="geturl" class="url" onclick="geturl()"></input>
<!--<div id="maint" class="m2tablediv" style="-webkit-overflow-scrolling:touch;white-space:wrap;">
  <table class="tablemain" id="tablemain">
    <thead>
      <tr class="tr2header">
        <td class="t2header">07/18/2017</td>
        <td class="t2header">07/17/2017</td>
        <td class="t2header">07/16/2017</td>
      </tr>
    </thead>
  <tbody class="m2body">
  </tbody>
  </table>
 </div>-->
 </div>


  </div>
<!--<div id="mapcontainer" class="mapcontainer">
</div>-->
<!--<canvas id="canvas" style="width:1000px;height:1000px"></canvas>-->
<div id="infocontainer" class="infocontainer">
   
</div>
<div id="infotext" class="infotext">
  <div id="infoheader" class="header">About this page</div>
  <div class="linedivider"></div>
  <div class="textinfo">This site compares the parallel GFSv16 to the operational GFSv15. Note that the 1-km reflectivity, instantaneous total/low/middle/high cloud cover, and cloud ceiling height parameters are only available in the parallel GFSv16. Instantaneous snow depth (SNOD) and 24-hr water equivalent of accumulated snow depth (WEASD) are available from Oct. 19, 2020 to present. From Oct. 28 to Dec. 22, 2020, EMC only ran the 00Z cycle for the parallel GFSv16. GFSv16 was implemented at 12Z on March 22, 2021. Full information about this upgrade can be found at the GFSv16 Evaluation Page <a href="https://www.emc.ncep.noaa.gov/users/meg/gfsv16/">here</a>.</div>
</div>
 <div id="footer" class="fcontainer">
  <div class="fshadow">
  <img src="NOAA-Transparent-Logo_1.png" alt="NOAA" class="noaaimage">
  <div class="ftext"><p>Environmental Modeling Center<br/>NOAA Center for Weather and Climate Prediction<br/>5830 University Research Court<br/>College Park, MD 20740</p></div>
  <img src="ncep_logo.gif" alt="NCEP" class="ncepimage">
  </div>
<br class="clear"/>
</div>
<script type='text/javascript'>

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}


function geturl() {
    window.location="https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/gfsximages.html?var="+vname1+"&dprog="+dprogq+"&domain="+domain+"&date="+currentymdh+"&imnum="+im1num
}
  

//This section is very important when adding more parameters
var im1num=0;
var vname1="slp";
var vnames=["slp",
"2mdew",
"sfct",
"2mt",
"10mwind",
"250wind",
"500",
"PBL",
"850wind",
"850t",
"pw",
"ref1km",
"refc",
"cape",
"shear",
"gust",
"totalprecip",
"24hprecip",
"3hprecip",
"cloud",
"cloudavg",
"lowcloud",
"lowcloudavg",
"midcloud",
"midcloudavg",
"highcloud",
"highcloudavg",
"ceiling",
"vis",
"ptype",
"snod",
"24hweasd",
"soilt",
"soilm"
];
var fullvnames={
"slp":"sea-level pressure",
"2mdew":"2-m dew point",
"sfct":"skin temperature",
"2mt":"2-m temperature",
"10mwind":"10-m winds",
"250wind":"250-hPa winds",
"500":"500-hPa heights",
"PBL":"PBL height",
"850wind":"850-hPa winds",
"850t":"850-hPa temperature",
"pw":"precipitable water",
"ref1km":"1-km reflectivity",
"refc":"composite reflectivity",
"cape":"surface-based CAPE",
"shear":"wind shear",
"gust":"surface wind gust",
"totalprecip":"total precipitation",
"24hprecip":"24-h precipitation",
"3hprecip":"3-h precipitation",
"cloud":"total cloud cover",
"cloudavg":"total cloud cover avg",
"lowcloud":"low cloud cover",
"lowcloudavg":"low cloud cover avg",
"midcloud":"middle cloud cover",
"midcloudavg":"middle cloud cover avg",
"highcloud":"high cloud cover",
"highcloudavg":"high cloud cover avg",
"ceiling":"cloud ceiling height",
"vis":"surface visibility",
"ptype":"precip type",
"snod":"snow depth (SNOD)",
"24hweasd":"24-h snowfall (WEASD)",
"soilt":"0-10 cm soil temperature",
"soilm":"0-10 cm soil moisture"
}
var domains=["ak",
"pac",
"us",
"uszoom",
"watl"
]
var fulldomains={
"ak":"Alaska",
"pac":"Pacific",
"us":"North America",
"uszoom":"CONUS",
"watl":"West Atlantic"
}
var nimages1={"rapon":81}
var initdate='2021031600';
var firstdate='2020071300';
var hourlist=[];
var domain="us"
for (var i=0;i<81;i+=1) {
    hourlist.push(("00"+String(i*3)).slice(-3));
  }
var hourdict={"rapon":hourlist}
var fullor="rapon"
var currentymdh=initdate.slice();
var currentymd=initdate.substr(0,8)
var iyear=parseInt(initdate.substr(0,4));
var imonth=parseInt(initdate.substr(4,2),10)-1;
if (imonth<0) {
  imonth=imonth+1;
  }
var iday=parseInt(initdate.substr(6,2),10);
var ihour=parseInt(initdate.substr(8,2),10);
cycledict=[];
ymddict=[];
daycount=0;
firstymd=0;






var domainq=getParameterByName('domain')
var dateq=getParameterByName('date')
var variableq=getParameterByName('var')
var dprogq=getParameterByName('dprog')
var im1numq=getParameterByName('imnum')
console.log(domainq);
if (dateq) {
  currentymdh=dateq;
  currentymd=currentymdh.substr(0,8);
}
if (domainq) {
  domain=domainq;
}
if (variableq) {
  vname1=variableq;
}
if (im1numq) {
  im1num=parseInt(im1numq,10);
}

nimages=81;

var wasitchecked=0;

if (dprogq=="yes") {
  console.log("inside");
  slider()
}
else {
  dprogq="no"
  console.log("chanvged")
  console.log(dprogq)
  console.log("________________")
  }
function corno() {
  console.log("corno");
  console.log(dprogq);
  if (dprogq=="yes") {
    dprogq="no"
   slider()
  }
  else {
    dprogq="yes"
    slider()
  }
}
     

//document.getElementById("toggle").checked=false;
check = d3.select("#toggle")
    .on("click",corno);
function slider() {
  console.log("changing slider")
  
  if (dprogq=="yes") {
    document.getElementById("toggle").checked=true;
    wasitchecked=1;
  if ( wasitchecked==1) {
      var futureymdh=returnymdh(initdate,240);
      if ((im1num*3)%6==0) {
         currentymdh=returnymdh(currentymdh,im1num*3);
         currentymd=currentymdh.substr(0,8);
         im1num=(im1num*3)/6;
        if (returndifhours(currentymdh,initdate)<0) {
           im1num=0;
        }
       }
      else {
         currentymdh=returnymdh(currentymdh,(im1num-1)*3);
         currentymd=currentymdh.substr(0,8);
         im1num=((im1num-1)*3)/6;
        if (returndifhours(currentymdh,initdate)<0) {
           im1num=0;
        }
      }
      console.log(futureymdh);
      datearrays(futureymdh);



    imurls=dprog();}
  else {
      if (returndifhours(currentymdh,initdate)<0) {
        currentymdh=initdate.slice();
        currentymd=initdate.substr(0,8);
       }
      datearrays(initdate);
    imurls=fullurl();
  }
  maximages=imurls.length;
  //if (im1num>maximages) {
 //   im1num=maximages-1;
 // }
    //im1num=0;
   errors=preloader() 
  }
  else {
    document.getElementById("toggle").checked='';
    wasitchecked=0;
  if ( wasitchecked==1) {
      var futureymdh=returnymdh(initdate,240);
      datearrays(futureymdh);
    imurls=dprog();}
  else {
      if (returndifhours(currentymdh,initdate)<0) {
        currentymdh=initdate.slice();
        currentymd=initdate.substr(0,8);
       }
      datearrays(initdate);
    imurls=fullurl();
  }
  maximages=imurls.length;
  //if (im1num>maximages) {
  //  im1num=maximages-1;
 // }
    im1num=0;
   errors=preloader() 
  }
}

function dprog() {
  //console.log("did dprog");
  //console.log(im1num);
  var sample=[];
    var x=(returndifhours(firstdate,currentymdh)/6)+1;
    if (x>41) {
      x=41;
    } 
    nimages=x;
    for (i=0;i<x;i++) {
      var thisymdh=returnymdh(currentymdh,i*-6)
      var thisymd=thisymdh.substr(0,8)
      var thisimnum=(returndifhours(thisymdh,currentymdh)/3)+1;
      if (returndifhours(thisymdh,initdate)>=0) {
      sample.push("https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+thisymd+"/gfsx_"+domain+"_"+vname1+"_"+thisymdh+"_"+("0"+String(thisimnum)).slice(-2)+".png");
      }

    }
  return sample 
};
function fullurl() {
    var i, urls = [];
    for(i = 0; i < nimages1[fullor]; i+=1) {
//          urls.push("compare"+vname1+currentymdh+"_00f"+i+'.gif');
          urls.push("https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+domain+"_"+vname1+"_"+currentymdh+"_"+("0"+String(i+1)).slice(-2)+".png");
     }
  return urls
}

//Set information button up
d3.select("#info").on("click",function(d) {
  d3.select("#infocontainer").style("display","block");
  d3.select("#infotext").style("display","block");
  d3.select("#info").classed("active",true);
  });
d3.select("#infocontainer").on("click",function(d) {
       d3.select("#infocontainer").style("display","none");
       d3.select("#infotext").style("display","none");
  d3.select("#info").classed("active",false);
  d3.select("#status").classed("active",false);
  d3.select(".domainimage").remove();
  })
d3.select("#status").on("click",function(d) {
  d3.select("#infocontainer").style("display","block");
  d3.select("#infocontainer").append("img").attr("src","compute.gif").attr("class","domainimage");
  d3.select("#status").classed("active",true);
  });
        
//Make sure footer is always at least just off the page
function setfooter() {
  var mainelement=document.getElementById('mastercontainer');
  var mainrect=mainelement.getBoundingClientRect();
  var sideelement=document.getElementById('sidecontainer');
  var siderect=sideelement.getBoundingClientRect();
  var ih=window.innerHeight || document.documentElement.clientHeight;
  var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  var posarray=[ih,mainrect.bottom+scrollTop,siderect.bottom+scrollTop]
  var footertop=d3.max(posarray)
  d3.select("#footer").style("top",footertop+"px");
}

 

//Utility function for index of maximum value in an array
function indexOfMax(arr) {
    if (arr.length === 0) {
        return -1;
    }

    var max = arr[0];
    var maxIndex = 0;

    for (var i = 1; i < arr.length; i++) {
        if (arr[i] > max) {
            maxIndex = i;
            max = arr[i];
        }
    }

    return maxIndex;
}


//Utility function to test equality of two arrays
function arraysEqual(arr1, arr2) {
    if(arr1.length !== arr2.length)
        return false;
    for(var i = arr1.length; i--;) {
        if(arr1[i] !== arr2[i])
            return false;
    }

    return true;
}



var format=d3.timeParse("%Y%m%d%H");
function datearrays(initdate) {
cycledict=[];
ymddict=[];
daycount=0;
firstymd=0;
var toi=((returndifhours(firstdate,initdate))/6)+1;
var todays=(returndifhours(firstdate,initdate))/24;
for (i=0;i<toi;i+=1) {
  if (i==0) {
    daycount=0;
    var prevymd=initdate.substr(0,8)
  }
  var thisymdh=returnymdh(initdate,-6*i);
  var thisymd=thisymdh.substr(0,8);
  var thish=thisymdh.substr(8,2);
  if (thisymd==prevymd && firstymd==0) {
    cycledict.push(["00"]); //cycledict.push([thish]);
    ymddict.push(thisymd);
    prevymd=thisymd;
    firstymd+=1;
  }
  else if (thisymd==prevymd) {
    cycledict.push(["00","12"]) //cycledict[daycount].push(thish)
    prevymd=thisymd;
  }
  else {
    //daycount+=1;
    //if (daycount>todays) {
      //break;
      //}
    cycledict.push(["00","12"]);
    ymddict.push(thisymd);
    prevymd=thisymd;
  }
 } 
initcyclemenu(ymddict,cycledict);
  
} //end datearrays

var headers=d3.selectAll(".t2header");
var dateheaders=headers._groups["0"];
for (i=0;i<dateheaders.length;i++) {
  dateheaders[i].innerText=ymddict[i];
}
//console.log(headers);

//Copied this from stack overflow. Function for initializing array of any size
function createArray(length) {
    var arr = new Array(length || 0),
        i = length;

    if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length-1 - i] = createArray.apply(this, args);
    }

    return arr;
}
var tablearray=createArray(24,3);
//var tablearray=[];
var cycles=["23Z","22Z","21Z","20Z","19Z","18Z","17Z","16Z","15Z","14Z","13Z","12Z","11Z","10Z","09Z","08Z","07Z","06Z","05Z","04Z","03Z","02Z","01Z","00Z"]
var tablecount=0;
var hourcount=0;
//var pp = d3.csv("GFSv16.csv",function(error,data) {
//    if (error) {console.log("there was an error");};
//    data.forEach(function(d) {
     //console.log(format(d.date));
     //console.log(d.status);
//     var thishour=parseInt(d.date.slice(-2),10);
     
//       tablearray[23-thishour][tablecount]={"hour":thishour,"status":d.status,"fulltime":d.date}
//     if (thishour==0) {
//      tablecount+=1;
//     }
     //console.log(tablearray);
//   });
//    var tr2=d3.select(".m2body").selectAll("tr")
//    .data(cycles)
//    .enter().append("tr")
//    .attr("id",function(d) {
//      return "t"+d
//     });
//    tr2.selectAll("td")
//      .data(function(d,i) {
//        return tablearray[i]})
//      .enter()
//        .append("td")
//        .attr("id",function(d) {
//          return d.status})
//        .text(function(d) {
//           return d.hour+"Z"})
//        .classed("u", function(d) {
//         if (d.status=="u") {
//             return true;
//         }
//         else {return false}
//         })
//        .classed("b", function(d) {
//         if (d.status=="b") {
//             return true;
//         }
//         else {return false}
//         })
//        .classed("g", function(d) {
//         if (d.status=="g") {
//             return true;
//         }
//         else {return false}
 //        })
//        .classed("i", function(d) {
//         if (d.status=="i") {
//             return true;
//         }
//         else {return false}
//         })
//        .classed("active", function(d) {
//         if (d.fulltime==currentymdh) {
//             return true;
//         }
//         else {return false}
//         })
//         .on("click",function(d) {
//            var td=d3.select(this)
//            //td.style("border-color","#000");
//            oldvaliddate=returnymdh(currentymdh,+hourdict[fullor][im1num]);
//            currentymdh=d.fulltime;
//            d3.select(".m2body").selectAll("tr").selectAll("td").each(function(d) {
//              var thisbox=d3.select(this);
//              thisbox
//        .classed("active", function(d) {
//         if (d.fulltime==currentymdh) {
//             return true;
//         }
//         else {return false}
//         });
//            });
//      ihour=parseInt(currentymdh.substr(8,2),10);

//  ex=0;
//  maximages=nimages[fullor];
//  var thishourarray=[];
//  for (i=0;i<hourdict[fullor].length;i++) {
//    thishourarray.push(hourdict[fullor][i]);
//  }
  //console.log(thishourarray);
//  fhour=fboxdata[im1num].ihour;
//  if (vname1=="pcp" || vname1=="lpcp" || vname1== "cpcp" ) {
//    thishourarray.splice(0,1);
//    maximages-=1;
//    //console.log(thishourarray);
//  }
//  
//  for (k=0;k<thishourarray.length;k+=1) {
//    if (thishourarray[k]==fhour) {
//      im1num=k;
//      ex=1;
//      break;
//     }
//   } 
//   if (fhour=="00") {
//      im1num=0}
//   if (ex==0) {
//      im1num=maximages-1;
//   }





//            //im1num=returndifhours(currentymdh,oldvaliddate)-1
//            jump()
//            errors=preloader()
//            hidedropcyclemenu()
//            var thishour=d.fulltime.slice(-2);
//            var thisymd=d.fulltime.substring(0,8);
//            d3.select("#afterdropcyclemenu").text(thisymd+" "+thishour+"Z");
//          });
//        
// });











var droppedimage1=false;
var droppedcyclemenu=false;
var droppeddomain=false;

function showdomain() {
    d3.select("#afterdomain").attr("class","select-styled active");
    d3.select(".ulsindomain").style("display","block")
    droppeddomain=true;
}
function hidedomain() {
    droppeddomain=false;
    d3.select(".ulsindomain").style("display","none")
    d3.select("#afterdomain").attr("class","select-styled");
}
function showdropimage1() {
    d3.select("#fsquare1").classed("iactive",true);
    d3.select("#fsquare1").select("#littlesquare1").style("background-color","white");
    d3.select("#afterdropimage1").attr("class","select-styled active");
    d3.select(".ulsindropimage").style("display","block")
    droppedimage1=true;
}
function hidedropimage1() {
    droppedimage1=false;
    d3.select(".ulsindropimage").style("display","none")
    d3.select("#afterdropimage1").attr("class","select-styled");
    d3.select("#fsquare1").classed("iactive",false);
    d3.select("#fsquare1").select("#littlesquare1").style("background-color","black");
}
function showdropcyclemenu() {
    d3.select("#afterdropcyclemenu").attr("class","select-styled active");
    //d3.select("#divdropcyclemenu").style("display","block")
    d3.select(".uldropimage").style("display","block")
    droppedcyclemenu=true;
}
function hidedropcyclemenu() {
    droppedcyclemenu=false;
    d3.select(".uldropimage").style("display","none")
    d3.select("#afterdropcyclemenu").attr("class","select-styled");
    d3.select(".subuldropcycle").style("display","none");
}

function changedomain() {
  if (!droppeddomain) {
    showdomain()
    hidedropcyclemenu()
    hidedropimage1
  }
  else {
    hidedomain()
  }
}
function changedropimage1() {
  if (!droppedimage1) {
    showdropimage1()
    hidedropcyclemenu()
    hidedomain()
  }
  else {
    hidedropimage1()
  }
}
function changedropcyclemenu() {
  if (!droppedcyclemenu) {
    showdropcyclemenu()
    hidedropimage1()
    hidedomain()
  }
  else {
    hidedropcyclemenu()
  }
}

var afterdropimage1=d3.select("#afterdropimage1")
  .text(fullvnames[vname1])
  .on("mousedown",changedropimage1);
afterdropimage1.property('value',vname1);
var uldropimage1=d3.select("#divdropimage1").append("ul")
  .attr("class","ulsindropimage");
uldropimage1.selectAll("li")
  .data(vnames)
  .enter().append("li")
    .attr("class","mainli")
    .text(function(d) { return fullvnames[d]; })
    .attr("id",function(d) { return "MDimage1"+String(d);});
uldropimage1.style("display","none");
var subdropimage1click="";
uldropimage1.selectAll(".mainli").on("click",function(d) {
  subdropimage1click=d;
  vname1=d;
  ex=0;
  maximages=nimages1[fullor];
  var thishourarray=[];
  for (i=0;i<hourdict[fullor].length;i++) {
    thishourarray.push(hourdict[fullor][i]);
  }
  fhour=fboxdata[im1num].ihour;
  if (vname1=="pcp" || vname1=="lpcp" || vname1== "cpcp" ) {
    thishourarray.splice(0,1);
    maximages-=1;
  }
  
  if ( wasitchecked==1) {
    imurls=dprog();}
  else {
    imurls=fullurl();
  }
  maximages=imurls.length;
  //console.log("im1num variable select");
  //console.log(im1num);
  if (im1num>maximages) {
    im1num=maximages-1;
  }
  errors=preloader()
  hidedropimage1()
var afterdropimage1=d3.select("#afterdropimage1")
  .text(fullvnames[vname1]);
});


var afterdomain=d3.select("#afterdomain")
  .text(fulldomains[domain])
  .on("mousedown",changedomain);
afterdomain.property('value',domain);
var uldomain=d3.select("#divdomain").append("ul")
  .attr("class","ulsindomain");
uldomain.selectAll("li")
  .data(domains)
  .enter().append("li")
    .attr("class","mainli")
    .text(function(d) { return fulldomains[d]; })
    .attr("id",function(d) { return "MDdomain"+String(d);});
uldomain.style("display","none");
var subdomainclick="";
uldomain.selectAll(".mainli").on("click",function(d) {
  subdomainclick=d;
  domain=d;
  if ( wasitchecked==1) {
    imurls=dprog();}
  else {
    imurls=fullurl();
  }
  maximages=imurls.length;
  if (im1num>maximages) {
    im1num=maximages-1;
  }
  errors=preloader()
  hidedomain()
var afterdomain=d3.select("#afterdomain")
  .text(fulldomains[domain]);
});




function initcyclemenu(ymddict,cycledict) {
var afterdropcyclemenu=d3.select("#afterdropcyclemenu")
  .text(currentymdh.substr(0,8)+" "+currentymdh.substr(8,2)+"Z")
  .on("mousedown",changedropcyclemenu);
d3.select(".uldropimage").remove();
var uldropcyclemenu=d3.select("#divdropcyclemenu").append("ul")
  .attr("class","uldropimage");
uldropcyclemenu.selectAll("li")
  .data(ymddict)
  .enter().append("li")
    .attr("class","mainli")
    .text(function(d) { return d; })
    .attr("id",function(d) { return "MDcyclemenu"+String(d);});
uldropcyclemenu.style("display","none");
subuldropcyclemenu=uldropcyclemenu.selectAll("li").append("ul")
  .data(ymddict)
    .attr("id",function(d) { return "Dcyclemenu"+String(d);})
    .attr("class","subuldropcycle");
for (j=0;j<cycledict.length;j++) {
  d3.select("#Dcyclemenu"+ymddict[j]).selectAll("li")
  .data(cycledict[j],function(d,i) { return d;})
  .enter().append("li")
    .attr("class","subli")
    .text(function(d,i) {return d+"Z";});
}
var subdropcyclemenuhover="";
uldropcyclemenu.selectAll(".mainli").on("mouseover",function(d) {
  subdropcyclemenuhover=d;
  for (i=0;i<ymddict.length;i++) {
    if (ymddict[i]==d) {
      document.getElementById("Dcyclemenu"+d).style.display="block";
    }
    else {
      document.getElementById("Dcyclemenu"+ymddict[i]).style.display="none";
    }
  }
  var thisitem=d3.select(this);
  thisid=thisitem._groups["0"]["0"].id;
  //console.log(thisid.slice(-18));

  var rect = document.getElementById(thisid).getBoundingClientRect();
  var rect2 = document.getElementById("afterdropcyclemenu").getBoundingClientRect();
  document.getElementById(thisid.slice(-18)).style.top=(rect.top-rect2.top)+"px";

});
var subdropcyclemenuclick="";
subuldropcyclemenu.selectAll(".subli").on("click",function(d) {
  subdropcyclemenuclick=d;
  oldvaliddate=returnymdh(currentymdh,im1num);
  currentymdh=subdropcyclemenuhover+subdropcyclemenuclick;
  currentymd=subdropcyclemenuhover;
            d3.select(".m2body").selectAll("tr").selectAll("td").each(function(d) {
              var thisbox=d3.select(this);
              thisbox
        .classed("active", function(d) {
         if (d.fulltime==currentymdh) {
             return true;
         }
         else {return false}
         });
            });
      ihour=parseInt(currentymdh.substr(8,2),10);
  ex=0;
  //maximages=nimages1[fullor];
  //if (im1num>maximages) {
  //  im1num=maximages-1;
 // }
  var thishourarray=[];
  for (i=0;i<hourdict[fullor].length;i++) {
    thishourarray.push(hourdict[fullor][i]);
  }
  //console.log(thishourarray);
  fhour=fboxdata[im1num].ihour;
  if (vname1=="pcp" || vname1=="lpcp" || vname1== "cpcp" ) {
    thishourarray.splice(0,1);
    maximages-=1;
    //console.log(thishourarray);
  }
  
 // for (k=0;k<thishourarray.length;k+=1) {
 //   if (thishourarray[k]==fhour) {
 //     im1num=k;
 //     ex=1;
 //     break;
 //    }
 //  } 
 //  if (fhour=="00") {
 //     im1num=0}
 //  if (ex==0) {
 //     im1num=maximages-1;
 //  }
  jump()
  if ( wasitchecked==1) {
    imurls=dprog();}
  else {
    imurls=fullurl();
  }
  maximages=imurls.length;
  //console.log("im1num in cycle menu");
  //console.log(im1num);
  if (im1num>maximages) {
    im1num=maximages-1;
  }
  errors=preloader()
  hidedropcyclemenu()
  d3.select("#afterdropcyclemenu").text(subdropcyclemenuhover+" "+subdropcyclemenuclick+"Z");
});

} //end initcyclemenu
//initcyclemenu();
if (dprogq!=="yes") {
datearrays(initdate);
}

//Function for returning date in yyyymmddhh format
function returnymdh(initdate,integer) {
                 inityear1=parseInt(initdate.substr(0,4));
                 initmonth1=parseInt(initdate.substr(4,2),10)-1;
                 initday1=parseInt(initdate.substr(6,2),10);
                 inithour1=parseInt(initdate.substr(8,2),10);
                 var diffdate=new Date(Date.UTC(inityear1,initmonth1,initday1,inithour1,0,0));
        var verfdate=new Date(Date.UTC(iyear,imonth,iday,ihour,0,0));
        verfdate=new Date(diffdate.getTime()+(60*(integer)*60000));
        minusyearverf=verfdate.getUTCFullYear();
        minusmonthverf=("0"+(verfdate.getUTCMonth()+1)).slice(-2);
        minusdayverf=("0"+(verfdate.getUTCDate())).slice(-2);
        minushourverf=("0"+(verfdate.getUTCHours())).slice(-2);
        vymdh=minusyearverf+minusmonthverf+minusdayverf+minushourverf;
        return vymdh
  }

function returndifhours(date1,date2) {
                 inityear1=parseInt(date1.substr(0,4));
                 initmonth1=parseInt(date1.substr(4,2),10)-1;
                 initday1=parseInt(date1.substr(6,2),10);
                 inithour1=parseInt(date1.substr(8,2),10);
                 var diffdate=new Date(Date.UTC(inityear1,initmonth1,initday1,inithour1,0,0));
                 inityear2=parseInt(date2.substr(0,4));
                 initmonth2=parseInt(date2.substr(4,2),10)-1;
                 initday2=parseInt(date2.substr(6,2),10);
                 inithour2=parseInt(date2.substr(8,2),10);
                 var diffdate2=new Date(Date.UTC(inityear2,initmonth2,initday2,inithour2,0,0));
                 var dif=(diffdate2-diffdate)/(1000*60*60);
        return dif
  }


//This is where bugs can occur; make sure things are loaded
function preloader() {
    function preload() {

    //Constructing forecast hour buttons
     fboxdata=[];

    //Loop from k to maximum number of images by largest temporal step
    for (k=0;k<urls.length;k+=1) {
      if (wasitchecked==0) {
      fboxdata.push({"inum":k,"itext":"F"+k*3,"ihour":k*3});
      }
      else {
      fboxdata.push({"inum":k,"itext":"F"+(parseInt(urls[k].split("/").slice(-1)[0].slice(-6,-4),10)*3-3),"ihour":k*6});
      }
    }

    //d3.selectfboxes.exit().remove(); 
    d3.select("#cfboxcontainer").selectAll("div").remove();
    var fboxes=d3.select("#cfboxcontainer").selectAll("div")
      .data(fboxdata, function(d) {
         return d.inum;
       });
    
    fboxes.enter().append("div")
      .attr("id",function (d,i) {
         return "fbox"+i;
      })
      .attr("class","fboxu")
      .text(function (d) {
        return d.itext;
      })
      .on("click", function(d) {
         im1num=d.inum;
         jump();                  

         });


    //Begin classed all unloaded
    fboxes
      .attr("class","fboxu");

    //It works, but minimages code is not in the right place
    var images = createArray(urls.length);
    //Create array that will be all 4s when everything is loaded
    var isloaded = createArray(urls.length);
    var iserror = createArray(urls.length);
      //for (j = 0; j < preload.arguments[i].length; j++) {
      for (j = 0; j < urls.length; j++) {
        iserror[j]=true;
      }

    //Loop through URLs to intialize images
    for (i = 0; i < preload.arguments.length; i++) {
        images[i] = new Image()
        images[i].src = preload.arguments[i]
        images[i].onerror = function(d) {
          console.log("error")
          for (ii=0;ii<urls.length;ii+=1) {
               if (ii==im1num) {
                 d3.select("#fbox"+ii)
                   .attr("class","fboxs");
                }
              if (d.target.src.split("/").slice(-1)[0]==urls[ii].split("/").slice(-1)[0]) {
                iserror[ii]=true;
                continue;
              }
           }
          };
        images[i].onload = function(d) {
          for (ii=0;ii<urls.length;ii++) {
             //console.log(d.target.src.split("/").slice(-1));
             //console.log(urls[ii].split("/").slice(-1));
             if (d.target.src.split("/").slice(-1)[0] == urls[ii].split("/").slice(-1)[0]) {
                iserror[ii]=false;
                 d3.select("#fbox"+ii)
                   .attr("class","fbox");

                 d3.select("#fbox"+ii)
                   .attr("class","fbox");
               if (ii==im1num) {
                 d3.select("#fbox"+ii)
                   .attr("class","fboxs");
                }
   
             }
                 setfooter();


    }



  }
}
    return iserror

}
    var i, urls = [];
    for(i = 0; i < nimages1[fullor]; i+=1) {
//          urls.push("compare"+vname1+currentymdh+"_00f"+i+'.gif');
          urls.push("https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+domain+"_"+vname1+"_"+currentymdh+"_"+("0"+String(i+1)).slice(-2)+".png");
     }
    //console.log(urls);
    date_list=[];
    fhours=[];
    if (vname1=="pcp" || vname1=="lpcp" || vname1 == "cpcp" ) {
      urls.splice(urls.length-1,1);
    } 
    for (i=0;i<nimages1[fullor];i+=1) {
      date_list.push(returnymdh(currentymdh,i));
      fhours.push(("00"+i).slice(-3));
    }


    //For everything after init
if (wasitchecked==1) {
  urls=dprog();
  }

var numload=0;
d3.select("#image1")
  //.attr("src","https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  .attr("src",urls[im1num])
  .on("error",function(d) {
      d3.select(this).attr("src","us.gif");
  });
    yyy=preload.apply(null, urls);
    return yyy

}

  if ( wasitchecked==1) {
    imurls=dprog();}
  else {
    imurls=fullurl();
  }
var maximages=imurls.length;
  if (im1num>maximages) {
    im1num=maximages-1;
  }
  //console.log("im1num initial");
  //console.log(im1num);
d3.select("#image1")
  //.attr("src","https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  .attr("src",imurls[im1num])
console.log(dprogq)
if (dprogq!=="yes") {
errors=preloader();
}


//Up, down, left, right functionality
window.addEventListener("keydown", function(event) {
    if([38, 40,37,39].indexOf(event.keyCode) > -1) {
event.preventDefault ? event.preventDefault() : (event.returnValue = false);
        }
}, false);
document.onkeydown = checkKey;
function checkKey(e) {
  e = e || window.event;
  if (e.keyCode == '37' ) {
     previous();
    }
  if (e.keyCode == '39' ) {
      next();
    }
  if (e.keyCode == '38' ) {
      up();
    }
  if (e.keyCode == '40' ) {
      down();
    }
}


function previous() {
if (im1num>0) {
  im1num-=1;
recolorf()
if (errors[im1num]) {
  d3.select("#image1")
    .attr("src","us.gif"); 
  }
else {
  d3.select("#image1")
  //  .attr("src","compare"+vname1+currentymdh+"_00f"+String(im1num)+".gif"); 
  //.attr("src","https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  .attr("src",imurls[im1num])
  }
}
}
    
function next() {
  console.log(im1num);
  console.log(maximages);
  console.log(imurls);
if (im1num<maximages-1) {
  im1num+=1;
recolorf()
if (errors[im1num]) {
  d3.select("#image1")
    .attr("src","us.gif"); 
  }
else {
  d3.select("#image1")
   // .attr("src","compare"+vname1+currentymdh+"_00f"+String(im1num)+".gif"); 
  //.attr("src","gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
 // .attr("src","https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  .attr("src",imurls[im1num])
  }
}
}

function jump() {
recolorf()
if (errors[im1num]) {
  d3.select("#image1")
    .attr("src","us.gif"); 
  }
else {
  d3.select("#image1")
    //.attr("src","compare"+vname1+currentymdh+"_00f"+String(im1num)+".gif"); 
  //.attr("src","gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  //.attr("src","https://www.emc.ncep.noaa.gov/users/meg/gfsv16/realtime/"+currentymd+"/gfsx_"+vname1+"_"+currentymdh+"_"+("0"+String(im1num+1)).slice(-2)+".png")
  .attr("src",imurls[im1num])
  }
}





//Color boxes based on if all images are loaded
function recolorf() {
       for (jj=0;jj<errors.length;jj++) {
               if (jj==(im1num)) {
                 d3.select("#fbox"+jj)
                   .attr("class","fboxs");
                }
               else if (!errors[jj]) {
                 d3.select("#fbox"+jj)
                   .attr("class","fbox");
                }
               else {
                 d3.select("#fbox"+jj)
                   .attr("class","fboxu");
                }
        }
  }

window.onresize = function(event) {
setfooter();
};


</script>
</body>
